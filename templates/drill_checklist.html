{% extends 'base.html' %}

{% block title %}{{ drill.title }} - Disaster Preparedness Education{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Navigation breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item">{{ drill.disaster_type.name }}</li>
            <li class="breadcrumb-item active" aria-current="page">{{ drill.title }}</li>
        </ol>
    </nav>
    
    <div class="row">
        <!-- Drill Content -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <span class="me-3" style="font-size: 1.5rem;">{{ drill.disaster_type.icon }}</span>
                            <div>
                                <h1 class="h4 mb-0">{{ drill.title }}</h1>
                                <small>{{ drill.disaster_type.name }} Emergency Drill</small>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="h5 mb-0" id="timeDisplay">00:00</div>
                            <small>Time Elapsed</small>
                        </div>
                    </div>
                </div>
                
                <div class="card-body">
                    {% if drill.description %}
                        <div class="alert alert-info mb-4">
                            <i data-feather="info" class="me-2"></i>
                            {{ drill.description }}
                        </div>
                    {% endif %}
                    
                    <!-- Drill Instructions -->
                    <div class="alert alert-warning mb-4">
                        <h6 class="alert-heading">
                            <i data-feather="alert-triangle" class="me-2"></i>Virtual Drill Instructions
                        </h6>
                        <ul class="mb-0">
                            <li>Read each step carefully</li>
                            <li>Check off each step as you complete it mentally</li>
                            <li>Pay special attention to critical steps marked in red</li>
                            <li>Some steps have time limits - practice completing them quickly</li>
                            <li>Click "Complete Drill" when finished</li>
                        </ul>
                    </div>
                    
                    <!-- Drill Form -->
                    <form method="post" action="{% url 'complete_drill' drill.id %}" id="drillForm">
                        {% csrf_token %}
                        <input type="hidden" name="time_taken" id="timeTaken" value="0">
                        
                        <!-- Progress Bar -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">Drill Progress</small>
                                <small class="text-muted" id="progressText">0 of {{ steps.count }} steps completed</small>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-warning" id="drillProgress" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <!-- Drill Steps -->
                        {% for step in steps %}
                        <div class="step-card mb-3" data-step="{{ step.id }}">
                            <div class="card {% if step.is_critical %}border-danger{% else %}border{% endif %}">
                                <div class="card-body">
                                    <div class="d-flex align-items-start">
                                        <div class="form-check me-3 mt-1">
                                            <input class="form-check-input" type="checkbox" 
                                                   name="step_{{ step.id }}" 
                                                   id="step{{ step.id }}"
                                                   onchange="updateProgress()"
                                                   {% if step.time_limit %}data-time-limit="{{ step.time_limit }}"{% endif %}>
                                        </div>
                                        <div class="flex-grow-1">
                                            <label class="form-check-label step-label" for="step{{ step.id }}">
                                                <div class="d-flex align-items-center mb-2">
                                                    <span class="badge {% if step.is_critical %}bg-danger{% else %}bg-primary{% endif %} me-2">
                                                        Step {{ step.order }}
                                                    </span>
                                                    {% if step.is_critical %}
                                                        <span class="badge bg-danger me-2">
                                                            <i data-feather="alert-circle" class="me-1"></i>Critical
                                                        </span>
                                                    {% endif %}
                                                    {% if step.time_limit %}
                                                        <span class="badge bg-warning text-dark">
                                                            <i data-feather="clock" class="me-1"></i>{{ step.time_limit }}s
                                                        </span>
                                                    {% endif %}
                                                </div>
                                                <div class="step-text">{{ step.step_text }}</div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- Submit Button -->
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-warning btn-lg text-dark" id="submitBtn">
                                <i data-feather="check-circle" class="me-2"></i>Complete Drill
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Drill Stats -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i data-feather="target" class="me-2"></i>Drill Overview
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <div class="stat-item">
                                <div class="h4 text-primary">{{ steps.count }}</div>
                                <small class="text-muted">Total Steps</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-item">
                                <div class="h4 text-danger">{% for step in steps %}{% if step.is_critical %}{{ forloop.counter0|add:1 }}{% endif %}{% endfor %}</div>
                                <small class="text-muted">Critical Steps</small>
                            </div>
                        </div>
                    </div>
                    
                    {% if best_completion > 0 %}
                    <div class="text-center">
                        <div class="h5 text-success">{{ best_completion|floatformat:0 }}%</div>
                        <small class="text-muted">Best Completion Rate</small>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Previous Completions -->
            {% if previous_completions %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i data-feather="clock" class="me-2"></i>Previous Attempts
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for completion in previous_completions %}
                        <div class="list-group-item d-flex align-items-center">
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge {% if completion.completion_percentage >= 90 %}bg-success{% elif completion.completion_percentage >= 70 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ completion.completion_percentage|floatformat:0 }}%
                                    </span>
                                    <small class="text-muted">{{ completion.completed_at|timesince }} ago</small>
                                </div>
                                <small class="text-muted">
                                    {{ completion.completed_steps }}/{{ completion.total_steps }} steps • 
                                    {{ completion.time_taken }}s
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Emergency Tips -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i data-feather="lightbulb" class="me-2"></i>Emergency Tips
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning mb-0">
                        <small>
                            <strong>Remember:</strong><br>
                            {% if drill.disaster_type.name == 'Earthquake' %}
                                Stay calm, drop immediately, take cover, and hold on until shaking stops.
                            {% elif drill.disaster_type.name == 'Flood' %}
                                Move to higher ground quickly and avoid walking through moving water.
                            {% elif drill.disaster_type.name == 'Fire' %}
                                Stay low under smoke, feel doors before opening, and never use elevators.
                            {% else %}
                                Follow emergency procedures and stay informed through official channels.
                            {% endif %}
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i data-feather="zap" class="me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'emergency_contacts' %}" class="btn btn-outline-danger btn-sm">
                            <i data-feather="phone" class="me-1"></i>Emergency Contacts
                        </a>
                        {% if drill.disaster_type.modules.exists %}
                            <a href="{% url 'module_detail' drill.disaster_type.modules.first.id %}" class="btn btn-outline-primary btn-sm">
                                <i data-feather="book-open" class="me-1"></i>Review Module
                            </a>
                        {% endif %}
                        <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary btn-sm">
                            <i data-feather="arrow-left" class="me-1"></i>Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let startTime = Date.now();
    let totalSteps = {{ steps.count }};
    
    // Timer
    function updateTimer() {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('timeDisplay').textContent = 
            String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
        document.getElementById('timeTaken').value = elapsed;
    }
    
    setInterval(updateTimer, 1000);
    
    // Progress tracking
    window.updateProgress = function() {
        const completedSteps = document.querySelectorAll('input[type="checkbox"]:checked').length;
        const progress = (completedSteps / totalSteps) * 100;
        
        document.getElementById('drillProgress').style.width = progress + '%';
        document.getElementById('progressText').textContent = completedSteps + ' of ' + totalSteps + ' steps completed';
        
        // Add visual feedback for completed steps
        document.querySelectorAll('input[type="checkbox"]').forEach(function(checkbox) {
            const card = checkbox.closest('.step-card');
            if (checkbox.checked) {
                card.classList.add('completed');
            } else {
                card.classList.remove('completed');
            }
        });
        
        // Pulse submit button when drill is complete
        const submitBtn = document.getElementById('submitBtn');
        if (completedSteps === totalSteps) {
            submitBtn.classList.add('pulse');
        } else {
            submitBtn.classList.remove('pulse');
        }
    };
    
    // Time limit warnings for steps
    document.querySelectorAll('input[type="checkbox"][data-time-limit]').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                const timeLimit = parseInt(this.getAttribute('data-time-limit'));
                const stepCard = this.closest('.step-card');
                
                // Add time pressure visual effect
                stepCard.style.animation = 'timeLimit ' + timeLimit + 's ease-out';
            }
        });
    });
    
    // Form submission
    document.getElementById('drillForm').addEventListener('submit', function(e) {
        const completedSteps = document.querySelectorAll('input[type="checkbox"]:checked').length;
        const completionRate = Math.round((completedSteps / totalSteps) * 100);
        
        if (!confirm(`You completed ${completedSteps} out of ${totalSteps} steps (${completionRate}%). Submit your drill results?`)) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}

{% block extra_css %}
<style>
    .step-card {
        transition: all 0.3s ease;
    }
    
    .step-card.completed {
        opacity: 0.8;
        background-color: rgba(40, 167, 69, 0.1);
    }
    
    .step-card.completed .card {
        border-color: #28a745 !important;
    }
    
    .step-label {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .step-text {
        font-size: 1.05rem;
        line-height: 1.5;
        margin-top: 0.5rem;
    }
    
    .form-check-input:checked + .step-label {
        text-decoration: line-through;
        opacity: 0.7;
    }
    
    .pulse {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    @keyframes timeLimit {
        0% { background-color: rgba(255, 193, 7, 0.3); }
        100% { background-color: transparent; }
    }
    
    .stat-item {
        padding: 0.5rem 0;
    }
    
    .border-danger {
        border-color: #dc3545 !important;
    }
</style>
{% endblock %}
